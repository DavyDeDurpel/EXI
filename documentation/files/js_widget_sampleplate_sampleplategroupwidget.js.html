<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js/widget/sampleplate/sampleplategroupwidget.js - EXI</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="EXI" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ManagerWelcomeMainView.html">ManagerWelcomeMainView</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: js/widget/sampleplate/sampleplategroupwidget.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
function SamplePlateGroupWidget(args){
	this.id = BUI.id();
	this.width = 900;
	this.height = 300;

	this.titleTypePlate = 20;

	this.margin = 0;
	this.samplePlateWidgets = [];

	this.bbar = false;
	this.border = 1;
	this.showTitle = true;
	this.title = null;
	
	this.nodeSize = 8;
	
	if (args != null){
		if (args.margin != null){
			this.margin = args.margin;
		}
		if (args.bbar != null){
			this.bbar = args.bbar;
		}

		if (args.showTitle != null){
			this.showTitle = args.showTitle;
			if (this.showTitle){
				this.title = &quot;Plates Groups&quot;;
			}
		}
		if (args.border != null){
			this.border = args.border;
		}
		if (args.height != null){
			this.height = args.height;
		}
	}
	
	this.heightPlates = this.height - this.titleTypePlate - 60;

	/** Events * */
	this.onClick = new Event(this);
	this.onExperimentChanged = new Event(this);
}


SamplePlateGroupWidget.prototype.drawPlate = function(experiment, plate, targetId){
	var _this = this;
	
	var samplePlateWidget = new SamplePlateWidget(
			{
				width		: (this.width/3) - 5, 
				height		: this.heightPlates + 10 , 
				nodeSize	: this.nodeSize, 
				fontSize	: 0, 
				strokeWidth	: 1.5
			});

	if (this.isVerticalLayout()){
		samplePlateWidget.width = this.width - 15;
		samplePlateWidget.height = this.heightPlates - 10;
	}
	
	samplePlateWidget.draw(experiment, plate, targetId );
	samplePlateWidget.onVertexUp.attach(function(sender, args){
		_this.onClick.notify(
				{
					samplePlate	: args.samplePlate, 
					row			: args.row, 
					column		: args.column

				}
		);
	});

	this.samplePlateWidgets.push(samplePlateWidget);
};

SamplePlateGroupWidget.prototype.drawPlates = function(experiment){
	if (experiment){
		var plateGroups = experiment.getPlateGroups();
		for ( var i = 0; i &lt; plateGroups.length; i++) {
			var id = plateGroups[i].plateGroupId;
			var plates = experiment.getPlatesByPlateGroupId(id);
			for ( var j = 0; j &lt; plates.length; j++) {
				var targetId = (&#x27;id&#x27;, this.id + &quot;_&quot; + plates[j].samplePlateId);
				if (document.getElementById(targetId) != null){
					this.drawPlate(experiment, plates[j], targetId);
				}
			}
		} 
	}
};

/*
SamplePlateGroupWidget.prototype._sortPlates = function(a, b) {
	return a.slotPositionColumn - b.slotPositionColumn;
};
*/

/** This returns maxSlotPositionRow and maxSlotPositionColumn to set visually the sample changer layout **/
SamplePlateGroupWidget.prototype.getDimensions = function(plates) {
	var maxSlotPositionRow = 0;
	var maxSlotPositionColumn = 0;
	
	if (plates != null){
		for (var i = 0; i &lt; plates.length; i++) {
			/** Row **/
			var slotPositionRow = plates[i].slotPositionRow;
			if (slotPositionRow != null){
				slotPositionRow = parseFloat(slotPositionRow);
				if (slotPositionRow &gt; maxSlotPositionRow){
					maxSlotPositionRow = slotPositionRow;
				}
			}
			/** Column **/
			var slotPositionColumn = plates[i].slotPositionColumn;
			if (slotPositionColumn != null){
				slotPositionColumn = parseFloat(slotPositionColumn);
				if (slotPositionColumn &gt; maxSlotPositionColumn){
					maxSlotPositionColumn = slotPositionColumn;
				}
			}
		}
	}
	return {
		&quot;maxSlotPositionRow&quot; 		: parseFloat(maxSlotPositionRow),
		&quot;maxSlotPositionColumn&quot;		: parseFloat(maxSlotPositionColumn)
	};
};

/** return true or false if the plates are going to be displayed vertically or horizontally **/
SamplePlateGroupWidget.prototype.isVerticalLayout = function() {
//	var dimensions = this.getDimensions(this.experiment.getSamplePlates())
//	if (dimensions.maxSlotPositionRow &lt; dimensions.maxSlotPositionColumn){
//		return false;
//	}
	return true;
};

/** This returns a sample plate object based on the position it occupies on the sample plate **/
SamplePlateGroupWidget.prototype.getPlateBySlotPosition = function(plates, row, column) {
	if (plates != null){
		for (var i = 0; i &lt; plates.length; i++) {
			/** Row **/
			if ((plates[i].slotPositionRow == row)&amp;&amp;(plates[i].slotPositionColumn == column)){
				return plates[i];
			}
		}
	}
	return null;
};

/** Returns the html that will be used to display the plates **/
SamplePlateGroupWidget.prototype.getPlatesContainer = function(experiment){
	var plateGroups = [];
	
	if (experiment!= null){
		plateGroups = experiment.getPlateGroups();
	}

	var div  = document.createElement(&quot;div&quot;);
	var table  = document.createElement(&quot;table&quot;);

	table.setAttribute(&#x27;width&#x27;, this.width - 30 + &#x27;px&#x27;);
	table.setAttribute(&#x27;height&#x27;, this.heightPlates + &#x27;px&#x27;);
	
	for ( var i = 0; i &lt; plateGroups.length; i++) {
		var id = plateGroups[i].plateGroupId;
		var plates = experiment.getPlatesByPlateGroupId(id);
		var dimensions = this.getDimensions(plates);
		
		for ( var j = 1; j &lt;= dimensions.maxSlotPositionRow; j++) {
			for ( var k = 1; k &lt;= dimensions.maxSlotPositionColumn; k++) {
			var tr = document.createElement(&quot;tr&quot;);
				var plate = this.getPlateBySlotPosition(plates,j,k);
				var td = document.createElement(&quot;td&quot;);
				td.setAttribute(&#x27;id&#x27;, this.id + &quot;_&quot; + plate.samplePlateId);
				td.setAttribute(&#x27;style&#x27;, &quot;background-color:#E6E6E6;border-width:1px;border-style:solid;&quot;);
				/** plate Type title * */
				var divTitle = document.createElement(&quot;div&quot;);
				divTitle.setAttribute(&quot;class&quot;, &quot;menu-title&quot;);
				var text = document.createTextNode(plate.platetype3VO.name);
				divTitle.appendChild(text);
				
				td.appendChild(divTitle);
				tr.appendChild(td);
				table.appendChild(tr);
			}
		}
	} 
	div.appendChild(table);
	return div.innerHTML;
};

SamplePlateGroupWidget.prototype.selectSpecimens = function(specimens){
	/** Clear previous selected * */
	for ( var i = 0; i &lt; this.samplePlateWidgets.length; i++) {
		this.samplePlateWidgets[i].clearSelection();
	}
	for ( var i = 0; i &lt; specimens.length; i++) {
		this.selectSpecimen(specimens[i]);
	}
};

SamplePlateGroupWidget.prototype.selectSpecimen = function(specimen){
	if (specimen.sampleplateposition3VO != null){
//		var samplePlateId = specimen.sampleplateposition3VO.samplePlateId;
		for ( var i = 0; i &lt; this.samplePlateWidgets.length; i++) {
//			var samplePlateId = this.samplePlateWidgets[i].samplePlate.samplePlateId;
			if ( this.samplePlateWidgets[i].samplePlate.samplePlateId == specimen.sampleplateposition3VO.samplePlateId){
				this.samplePlateWidgets[i].selectSpecimen(specimen);
				return;
			}
		}
	}
};

SamplePlateGroupWidget.prototype._refreshBbar = function(){
	if (this.panel != null){
		this.panel.removeDocked(Ext.getCmp( this.id + &#x27;bbar&#x27;));
		this.panel.addDocked(this.getBbar());
	}
};

SamplePlateGroupWidget.prototype.refresh = function(experiment){
	this.experiment = experiment;
	this.samplePlateWidgets = [];

	if (document.getElementById(this.id + &quot;_container&quot;) != null){
		document.getElementById(this.id + &quot;_container&quot;).innerHTML = &quot;&quot;;
		document.getElementById(this.id + &quot;_container&quot;).innerHTML = this.getPlatesContainer(experiment);
		this.drawPlates(experiment);
	}

	/** We refrsh also the bbar  but it could not exist yet* */
	this._refreshBbar();	
	

};

SamplePlateGroupWidget.prototype._getAutoFillButton = function(){
	var _this = this;
	var item = null;
	function onButtonClick(){

	}

	function showResult(answer){
		if (answer == &#x27;yes&#x27;){
			var samplePlateId = item.samplePlateId;
			var adapter = new BiosaxsDataAdapter();
			_this.panel.setLoading(&quot;ISPyB: Saving Plate&quot;);
			adapter.onSuccess.attach(function(sender, json){
				_this.onExperimentChanged.notify(json);
				_this.panel.setLoading(false);
			});
			adapter.onError.attach(function(sender){
				alert(&quot;error&quot;);
				_this.panel.setLoading(false);
			});
			adapter.autoFillPlate(samplePlateId, _this.experiment.experimentId);
		}
	}

	function onItemClick(i){
		item = i;
		Ext.MessageBox.confirm(&#x27;Confirm&#x27;, &#x27;Are you sure you want to fill &quot;&#x27;+ _this.experiment.getSamplePlateById(item.samplePlateId).platetype3VO.name + &#x27;&quot; plate?&#x27;, showResult);
	}


	var items = [];
	items.push( &#x27;&lt;b class=&quot;menu-title&quot;&gt;Select a plate:&lt;/b&gt;&#x27;);

	if (this.experiment){
		var plates = this.experiment.getSamplePlates();
		plates.sort(function(a,b){return a.slotPositionColumn - b.slotPositionColumn;});
		for ( var i = 0; i &lt; plates.length; i++) {
			items.push({
				samplePlateId			:  plates[i].samplePlateId,
				text					: (i+1) + &#x27;.- &lt;b&gt; &#x27; + plates[i].platetype3VO.name +&#x27;&lt;/b&gt;&#x27;, 
				handler				: onItemClick
			});
		}
	}

	return Ext.create(&#x27;Ext.button.Split&#x27;, {
		text		: &#x27;Auto Fill&#x27;,
		handler		: onButtonClick,
		tooltip		: {text:&#x27;This will fill, if there is place, the specimens in the plate&#x27;, title:&#x27;Auto Fill&#x27;},
		menu : {
			items: items
		}
	});
};

SamplePlateGroupWidget.prototype._getZoomButton = function(){
	var _this = this;
	var item = null;

	function onItemClick(item){
// Ext.MessageBox.confirm(&#x27;Confirm&#x27;, &#x27;Are you sure you want to empty &quot;&#x27;+
// _this.experiment.getSamplePlateById(item.samplePlateId).platetype3VO.name +
// &#x27;&quot; plate?&#x27;, showResult);
		Ext.create(&#x27;Ext.window.Window&#x27;, {
			title	: _this.experiment.getSamplePlateById(item.samplePlateId).platetype3VO.name,
			height	: 600,
			width	: 900,
			layout	: &#x27;fit&#x27;,
			modal	: true,
			listeners: {
				afterrender: function(){
					var samplePlateWidget = new SamplePlateWidget(
							{
								width		: 880, 
								height		: 560, 
								nodeSize	: 4, 
								fontSize	: 0, 
								strokeWidth	: 1.5,
								showLabels	: true,
								backgroundColor : &#x27;#FFFFFF&#x27;
							});

					samplePlateWidget.draw(_this.experiment, _this.experiment.getSamplePlateById(item.samplePlateId), &quot;plateZoom&quot; );
				}
			},
			items	: [
			     	   {
			     		   html 	: &#x27;&lt;div id=&quot;plateZoom&quot; style=&quot;background-color:red&quot;&gt;&lt;/div&gt;&#x27;,
			     		   padding 	: 5
			     	   }
			     	   ]
		}).show();

	}


	var items = [];
	if (this.experiment){
		var plates = this.experiment.getSamplePlates();
		plates.sort(function(a,b){return a.slotPositionColumn - b.slotPositionColumn;});
	
		items.push( &#x27;&lt;b class=&quot;menu-title&quot;&gt;Select a plate:&lt;/b&gt;&#x27;);
		for ( var i = 0; i &lt; plates.length; i++) {
			items.push({
				samplePlateId			:  plates[i].samplePlateId,
				text					: (i+1) + &#x27;.- &lt;b&gt; &#x27; + plates[i].platetype3VO.name +&#x27;&lt;/b&gt;&#x27;, 
				handler				: onItemClick
			});
		}
	}

	return Ext.create(&#x27;Ext.button.Split&#x27;, {
		text		: &#x27;Zoom In&#x27;,
		tooltip		: {text:&#x27;This will show a plate bigger&#x27;, title:&#x27;Zoom In Action&#x27;},
		menu 		: {
			items: items
		}
	});
};


SamplePlateGroupWidget.prototype._getEmptyButton = function(){
	var _this = this;
	var item = null;
	function onButtonClick(){

	}

	function showResult(answer){
		if (answer == &#x27;yes&#x27;){
			var samplePlateId = item.samplePlateId;
			var adapter = new BiosaxsDataAdapter();
			_this.panel.setLoading(&quot;ISPyB: Saving Plate&quot;);
			adapter.onSuccess.attach(function(sender, json){
				_this.onExperimentChanged.notify(json);
				_this.panel.setLoading(false);
			});
			adapter.onError.attach(function(sender){
				alert(&quot;error&quot;);
				_this.panel.setLoading(false);
			});
			adapter.emptyPlate(samplePlateId, _this.experiment.experimentId);
		}
	}

	function onItemClick(i){
		item = i;
		Ext.MessageBox.confirm(&#x27;Confirm&#x27;, &#x27;Are you sure you want to empty &quot;&#x27;+ _this.experiment.getSamplePlateById(item.samplePlateId).platetype3VO.name + &#x27;&quot; plate?&#x27;, showResult);
	}


	var items = [];
	
	if (this.experiment){
		var plates = this.experiment.getSamplePlates();
		plates.sort(function(a,b){return a.slotPositionColumn - b.slotPositionColumn;});
	
		items.push( &#x27;&lt;b class=&quot;menu-title&quot;&gt;Select a plate:&lt;/b&gt;&#x27;);
		for ( var i = 0; i &lt; plates.length; i++) {
			items.push({
				samplePlateId			:  plates[i].samplePlateId,
				text					: (i+1) + &#x27;.- &lt;b&gt; &#x27; + plates[i].platetype3VO.name +&#x27;&lt;/b&gt;&#x27;, 
				handler				: onItemClick
			});
		}
	}
	return Ext.create(&#x27;Ext.button.Split&#x27;, {
		text		: &#x27;Empty&#x27;,
		handler		: onButtonClick,
		tooltip		: {text:&#x27;This will empty the specimen of a plate. It will NOT remove the specimen but will removed their position&#x27;, title:&#x27;Empty Action&#x27;},
		menu : {
			items: items
		}
	});
};

SamplePlateGroupWidget.prototype._getPlateTypes = function(){
	var _this = this;
	var item = null;
	function onButtonClick(){

	}

	function changeType(answer){
		if (answer == &#x27;yes&#x27;){
			var samplePlateId = item.samplePlateId;
			var plateTypeId = item.plateTypeId;

			var plateType = BIOSAXS.proposal.getPlateTypeById(plateTypeId);
			var plate = _this.experiment.getSamplePlateById(samplePlateId);
			plate.platetype3VO = plateType;

			var samplePlateId = item.samplePlateId;
			var adapter = new BiosaxsDataAdapter();
			_this.panel.setLoading(&quot;ISPyB: Saving Plate&quot;);
			adapter.onSuccess.attach(function(sender, json){
				_this.onExperimentChanged.notify(json);
				_this.panel.setLoading(false);
			});
			adapter.onError.attach(function(sender){
				alert(&quot;error&quot;);
				_this.panel.setLoading(false);
			});
			adapter.savePlates([plate], _this.experiment.experimentId);
		}
	}

	function onItemCheck(i){
		item = i;
		var samplePlateId = i.samplePlateId;
		var plateTypeId = i.plateTypeId;

		if (_this.experiment.getSamplePlateById(samplePlateId).platetype3VO.plateTypeId != plateTypeId){
			Ext.MessageBox.confirm(&#x27;Confirm&#x27;, &#x27;Are you sure you want to change the type of &quot;&#x27;+ _this.experiment.getSamplePlateById(item.samplePlateId).platetype3VO.name + &#x27;&quot; plate?&#x27;, changeType);
		}
	}


	var items = [];
	items.push( &#x27;&lt;b class=&quot;menu-title&quot;&gt;Select an EMPTY plate:&lt;/b&gt;&#x27;);
	
	var plates = [];
	if (this.experiment != null){
		plates = this.experiment.getSamplePlates();
	}
	plates.sort(function(a,b){return a.slotPositionColumn - b.slotPositionColumn;});


	var types = ProposalManager.getPlateTypes();

	for ( var i = 0; i &lt; plates.length; i++) {
		var plate = plates[i];
		var itemTypes = [];
		for ( var j = 0; j &lt; types.length; j++) {

			itemTypes.push({
				text			: types[j].name,
				plateTypeId		: types[j].plateTypeId,
				samplePlateId	: plate.samplePlateId,
				checked			: (plate.platetype3VO.plateTypeId == types[j].plateTypeId),
				group			: &#x27;theme&#x27; + plate.samplePlateId,
				checkHandler	: onItemCheck
			});
		}

		items.push({
			text		: (i+1) + &#x27;.- &lt;b&gt; &#x27; + plate.platetype3VO.name +&#x27;&lt;/b&gt;&#x27;,
			disabled	: (_this.experiment.getSpecimensBySamplePlateId(plate.samplePlateId).length &gt; 0),
			menu		: {       
				items		: itemTypes
			}
		});
	}

	return Ext.create(&#x27;Ext.button.Split&#x27;, {
		text		: &#x27;Plate Types&#x27;,
		handler		: onButtonClick,
		tooltip		: {text:&#x27;This will change the type of a plate.&#x27;, title:&#x27;Change plate type&#x27;},
		menu : {
			items: items
		}
	});
};

SamplePlateGroupWidget.prototype.getBbar = function(experiment){
	var _this = this;
	if (this.bbar){
		return  Ext.create(&#x27;Ext.toolbar.Toolbar&#x27;, {
			id	: _this.id + &#x27;bbar&#x27;,
			dock: &#x27;bottom&#x27;,
			items: [
			        this._getPlateTypes(),
			        &quot;-&quot;,
			        this._getAutoFillButton(),
			        this._getEmptyButton(),
			        &quot;-&quot;,
			        this._getZoomButton()
			        ]
		});
	}
	return null;
};

SamplePlateGroupWidget.prototype.getPanel = function(){
	var _this = this;
	
	var id = this.id + &quot;_container&quot;; 
	this.panel =  Ext.create(&#x27;Ext.panel.Panel&#x27;, {
		title		: this.title,
		bbar		: this.getBbar(),
		height		: this.height,
		width		: this.width,
		border		: this.border,
		items		: [
					        {
					        	border		: 0,
					        	height		: this.height,
					        	id			: id,
					        	html		: &quot;&lt;div id=&#x27;&quot;+ id +&quot;&#x27;&gt;&lt;/div&gt;&quot;
					        }
					   ]
	});

	this.panel.on(&quot;afterrender&quot;, function(){
		document.getElementById(id).innerHTML = _this.getPlatesContainer(_this.experiment);
		_this.drawPlates(_this.experiment);
		_this._refreshBbar();
	});
	return this.panel ;
};
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
