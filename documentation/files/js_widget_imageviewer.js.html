<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js/widget/imageviewer.js - EXI</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="EXI" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AutoProcIntegrationGrid.html">AutoProcIntegrationGrid</a></li>
                                <li><a href="../classes/ManagerWelcomeMainView.html">ManagerWelcomeMainView</a></li>
                                <li><a href="../classes/PhasingNetworkWidget.html">PhasingNetworkWidget</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: js/widget/imageviewer.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
function ImageViewer(args){

	this.width = 500;
	this.height = 500;
	this.id = BUI.id();

	/** cordinates to the beam center **/
	this.center = null;
	this.url = null;
	this.zoom = 1;

	this.offsetX = 0;
	this.offsetY = 0;
	
	/** Allows to detect drag **/
	this._isDragging = false;
	this._draggingPoint = {x : 0, y : 0};
	

	this.selectedPoints = [];


	/** When user clicks on two points it calculates the luminic intensity **/
	this.allowLuminance = true;


	if (args != null){
		if (args.width != null){
			this.width = args.width;
		}
		if (args.height != null){
			this.height = args.height;
		}
		if (args.zoom != null){
			this.zoom = args.zoom;
		}
		if (args.offsetX != null){
			this.offsetX = args.offsetX;
		}
		if (args.offsetY != null){
			this.offsetY = args.offsetY;
		}
		if (args.allowLuminance != null){
			this.allowLuminance = args.allowLuminance;
		}


	}

	this.selectedPoints = [];

	this.onMouseOver = new Event(this);
	this.onMouseClick = new Event(this);
	this.onMouseDown = new Event(this);
	this.onMouseUp = new Event(this);
	this.onDblClick = new Event(this);
	this.onMouseRightDown = new Event(this);
	this.onLuminanceCalculated = new Event(this);
	this.onLuminanceReset = new Event(this);
	this.onRendered = new Event(this);
}

ImageViewer.prototype.getCanvas = function(url){
	return document.getElementById(this.id);
};

ImageViewer.prototype.getContext = function(url){
	return this.getCanvas().getContext(&#x27;2d&#x27;);
};

ImageViewer.prototype.getPanel = function(){
	return &#x27;&lt;canvas style=&quot;border: 1px solid gray;&quot; id=&quot;&#x27; + this.id +&#x27;&quot; width=&quot;&#x27; + this.width +&#x27;&quot; height=&quot;&#x27; + this.height +&#x27;&quot;&gt;&lt;/canvas&gt;&#x27;;
};

ImageViewer.prototype.clear= function(){
	this.getContext().clearRect(0, 0, this.getCanvas().width, this.getCanvas().height);
};

ImageViewer.prototype.findPosition = function(obj) {
    var curleft = 0, curtop = 0;
    if (obj.offsetParent) {
	do {
	    curleft += obj.offsetLeft;
	    curtop += obj.offsetTop;
	} while (obj = obj.offsetParent);
	return { x: curleft, y: curtop };
    }
    return undefined;
};


ImageViewer.prototype.rgbToHex = function(r, g, b) {
	    if (r &gt; 255 || g &gt; 255 || b &gt; 255){
		throw &quot;Invalid color component&quot;;
		}
	    return ((r &lt;&lt; 16) | (g &lt;&lt; 8) | b).toString(16);
};

ImageViewer.prototype.getMatrix = function() {
	var data = [];
	for (var x = 0; x &lt; this.width; x++){
		data[x] = new Array(Math.floor(this.height));
		for (var y = 0; y &lt; this.height; y++){
			data[x][y] = (this.getColorLuminance(x, y));
		}

	}
	return data;
};


ImageViewer.prototype.getCoordinatesInfo = function(obj, e) {
     	var pos = this.findPosition(obj);
    	var x = e.pageX - pos.x;
    	var y = e.pageY - pos.y;
    	var p = this.getContext(&#x27;2d&#x27;).getImageData(x, y, 1, 1).data; 
   	var hex = &quot;#&quot; + (&quot;000000&quot; + this.rgbToHex(p[0], p[1], p[2])).slice(-6);
	return {
						x 	: (x/this.zoom)- this.offsetX,
						y 	: (y/this.zoom) - this.offsetY,
						localX	: x,
						localY	: y,
						offsetX	: this.offsetX,
						offsetY	: this.offsetY,
						zoom	: this.zoom,
						color 	: hex
	};
};

ImageViewer.prototype.getColorLuminance = function(x,y){
	var p = this.getContext(&#x27;2d&#x27;).getImageData((this.offsetX + x)*this.zoom, y*this.zoom, 1, 1).data;
	return Math.floor((0.2126*p[0] + 0.7152*p[1] + 0.0722*p[2]));
};

/**
Vertical gradient is undefined for vertical line
https://www.mathsisfun.com/algebra/line-equation-2points.html
**/
ImageViewer.prototype.getAllPoints = function(x1, y1, x2, y2){
	if (x1 &gt; x2){
		var aux = x1;
		var auxy = y1;
		x1 = x2;
		x2 =aux;

		y1 = y2;
		y2 =auxy;

	}
	var points = [];
	var ratio = (y2 - y1) / (x2 - x1);
	var width = x2 - x1;
	for(var i = 0; i &lt; width; i++) {
	    var x = x1 + i;
	    var y = y1 + (ratio * i);
	    points.push({x: x, y: y});
	}
	return points;
};


ImageViewer.prototype.drawLine = function(x1, y1, x2, y2, color){
	this.drawPoints(this.getAllPoints(x1, y1, x2, y2), color);
};


ImageViewer.prototype.drawPoints = function(points, color){
	var _this = this;
	this.clear();
	this.reload(function(){
				var context = _this.getContext();
				for(var i  =0 ; i &lt; points.length; i++){
					var x = ((points[i].x  + _this.offsetX)*_this.zoom);
					var y = points[i].y*_this.zoom;

					context.beginPath();
	      				context.arc(x, y, 1, 0, 2 * Math.PI, false);
					context.fillStyle = color;
					context.fill();
					context.lineWidth = 1;
					context.strokeStyle = color;
					context.stroke();
				}
				
	});
};


ImageViewer.prototype.drawPoint = function(x, y, color){
	var _this = this;
	this.clear();

	x = (_this.offsetX + x)*_this.zoom;
	y = y*_this.zoom;
	this.reload(function(){
				var context = _this.getContext();
				context.beginPath();
      				context.arc(x, y, 2, 0, 2 * Math.PI, false);
				context.fillStyle = color;
			        context.fill();
			        context.lineWidth = 1;
			        context.strokeStyle = color;
				context.stroke();
	});
};

ImageViewer.prototype.drawCross = function(x, y, height, color){
	var context = this.getContext();
	context.strokeStyle = color;
	context.beginPath();
	context.moveTo(x, y - 10);
	context.lineTo(x, y + 10);
	context.stroke();
	context.moveTo(x - 10, y);
	context.lineTo(x + 10, y);
	context.stroke();

};
ImageViewer.prototype.drawCenterBeam = function(f){
	var x = this.center.x*this.zoom + this.offsetX ;
	var y = this.center.y*this.zoom + this.offsetY ;
	this.drawCross(x,y,10, &quot;#990099&quot;);
};

ImageViewer.prototype.reload = function(f){
	var _this = this;
	var img = new Image();
	img.crossOrigin = &quot;Anonymous&quot;;
	img.src = this.url;

	/** Clear context **/
	this.clear();

	img.onload = function() {
		var context = _this.getContext();
		context.drawImage(img, _this.offsetX, _this.offsetY, _this.width*_this.zoom, _this.height*_this.zoom);
		f();

		if (_this.center != null){
			_this.drawCenterBeam();
		}

		
	}
};

ImageViewer.prototype.luminance = function(point){
	var _this = this;
	_this.selectedPoints.push({
		x : point.x ,
		y : point.y + this.offsetY
	});
	
	if (_this.selectedPoints.length == 2){
		/** Printing scale plot gray **/
		console.log(_this.selectedPoints);
		var points = _this.getAllPoints(_this.selectedPoints[0].x, _this.selectedPoints[0].y, _this.selectedPoints[1].x, _this.selectedPoints[1].y);
		var luminance = [];
		for(var i = 0; i&lt; points.length; i++){
			luminance.push({
						luminance 	 : _this.getColorLuminance(points[i].x, points[i].y),
						x		 : points[i].x,
						y		 : points[i].y

					});

		}
		
		/** Drawing line **/
		_this.drawLine(_this.selectedPoints[0].x, _this.selectedPoints[0].y, _this.selectedPoints[1].x, _this.selectedPoints[1].y, &quot;#ACFA58&quot;);
		

		_this.onLuminanceCalculated.notify(luminance);

	}
	if (_this.selectedPoints.length == 1){
		_this.drawPoint(_this.selectedPoints[0].x, _this.selectedPoints[0].y, &quot;#ACFA58&quot;);
	}
};


ImageViewer.prototype.redraw = function(zoom, offsetX, offsetY){
	this.zoom = zoom;
	this.offsetX = offsetX;
	this.offsetY = offsetY;
	this.reload(function(){});
};

ImageViewer.prototype.applyZoomOnPoint = function(point, zoom){

	this.zoom = 5;

	var newX = (point.localX) * this.zoom;
	var newY = (point.localY) * this.zoom
	var offSetX = -(newX - point.x);
	var offSetY = -(newY - point.y);
	var offsetX = offSetX - (point.x - point.localX);
	var offsetY = offSetY - (point.y - point.localY);

		/** redraw **/
	this.redraw(this.zoom, offsetX, offsetY);
};


ImageViewer.prototype.load = function(url){
	var _this = this;

	/** If not initialized yet **/
	if (this.url == null){
		/** Attaching mouse over event **/
		$(&#x27;#&#x27; + _this.id).mousemove(function(e) {
			_this.onMouseOver.notify(_this.getCoordinatesInfo(this, e));
			if (_this._isDragging){
				var pos = _this.findPosition(this);
			    	var x = e.pageX - pos.x;
			    	var y = e.pageY - pos.y;
				_this.offsetX = _this.offsetX + (x - _this._draggingPoint.x);
				_this.reload(function(){});
			}
		});

		$(&#x27;#&#x27; + _this.id).click(function(e) {
	 		_this.onMouseClick.notify(_this.getCoordinatesInfo(this, e));
			if (_this.allowLuminance){
				if (_this.selectedPoints.length &lt; 2){
					_this.luminance(_this.getCoordinatesInfo(this, e));
				}
				else{
					_this.selectedPoints = [];
					_this.redraw(_this.zoom, _this.offsetX, _this.offsetY);
					_this.onLuminanceReset.notify();
				}

			}
		});

		$(&#x27;#&#x27; + _this.id).dblclick(function(e) {
			_this.onDblClick.notify(_this.getCoordinatesInfo(this, e));
		});



		$(&#x27;#&#x27; + _this.id).mouseup(function(e) {
			var wasDragging = _this._isDragging;
			_this._isDragging = false;
			if (!wasDragging) {
				console.log(&quot;dragging&quot;);
			}

	 		_this.onMouseUp.notify(_this.getCoordinatesInfo(this, e));
		});

		$(&#x27;#&#x27; + _this.id).mousedown(function(e) {

			if( e.button == 2 ) { 
				document.oncontextmenu = function() {return false;};
      				_this.onMouseRightDown.notify(_this.getCoordinatesInfo(this, e));
				
    			} 
			else{
				_this._isDragging = true;
				var pos = _this.findPosition(this);
				_this._draggingPoint = {
							x : e.pageX - pos.x,
							y : e.pageY - pos.y,
				};
		 		_this.onMouseDown.notify(_this.getCoordinatesInfo(this, e));
			}
		});

	}

	this.url = url;

	
	var img = new Image();
	img.crossOrigin = &quot;Anonymous&quot;;
	img.src = url;

	/** Clear context **/
	this.clear();

	img.onload = function() {
		var context = _this.getContext();
		context.drawImage(img, _this.offsetX, _this.offsetY, _this.width*_this.zoom, _this.height*_this.zoom);
		/*if (_this.width &lt; 200){
			document.write(&quot;var data = &quot; + JSON.stringify(_this.getMatrix()) + &quot;;&quot;)
		}*/
		/** Drawing center beam **/
		if (_this.center != null){
			_this.drawCenterBeam();
		}

		_this.onRendered.notify();
		
	};
};


    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
