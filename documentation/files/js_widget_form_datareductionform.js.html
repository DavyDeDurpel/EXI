<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js/widget/form/datareductionform.js - EXI</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="EXI" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AutoProcIntegrationGrid.html">AutoProcIntegrationGrid</a></li>
                                <li><a href="../classes/ManagerWelcomeMainView.html">ManagerWelcomeMainView</a></li>
                                <li><a href="../classes/ParcelGrid.html">ParcelGrid</a></li>
                                <li><a href="../classes/ParcelPanel.html">ParcelPanel</a></li>
                                <li><a href="../classes/PhasingNetworkWidget.html">PhasingNetworkWidget</a></li>
                                <li><a href="../classes/ShippingMainView.html">ShippingMainView</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: js/widget/form/datareductionform.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Example form
 * 
 * @witdh
 * @height
 */
function DataReductionForm(args) {
	this.id = BUI.id();
	this.width = null;
	this.height = null;

	if (args != null) {
		if (args.width != null) {
			this.width = args.width;
		}
		if (args.height != null) {
			this.height = args.height;
		}
	}

	var _this = this;

	/** Widgets **/
	this.plotWidget = new PlotWidget({
		width : 650,
		height : 490
	});

	/** Selected frames to be displayed **/
	this.selectedItems = {
		frames : [],
		averages : [],
		subtractions : []
	};

}

DataReductionForm.prototype._parseSelectedItemsToIds = function(selectedArray) {
	var ids = [];
	if (selectedArray != null) {
		for (var i = 0; i &lt; selectedArray.length; i++) {
			ids.push(selectedArray[i].id);
		}
	}
	return ids;
};

DataReductionForm.prototype.onSelectionChanged = function(columnName, selected) {
	if (selected != null) {
		if (columnName == &quot;Frames&quot;) {
			this.selectedItems.frames = selected;
			this.selectedItems.subtractions = [];
		}
		if (columnName == &quot;Averages&quot;) {
			this.selectedItems.averages = selected;
		}
		if (columnName == &quot;Subtractions&quot;) {
			this.selectedItems.frames = [];
			this.selectedItems.subtractions = selected;
		}
	}
	this.plotWidget.refresh(this._parseSelectedItemsToIds(this.selectedItems.frames), this._parseSelectedItemsToIds(this.selectedItems.subtractions));
};

DataReductionForm.prototype._getFramesExtPanel = function(store, columnName, height) {
	var _this = this;

	var selModel = Ext.create(&#x27;Ext.selection.RowModel&#x27;, {
		allowDeselect : true,
		mode : &#x27;MULTI&#x27;,
		listeners : {
			selectionchange : function(sm, selections) {
				var selected = [];
				for (var i = 0; i &lt; selections.length; i++) {
					selected.push(selections[i].data);
				}
				_this.onSelectionChanged(columnName, selected);
			}
		}
	});

	return Ext.create(&#x27;Ext.grid.Panel&#x27;, {
		store : store,
		margin : 10,
		height : height,
		width : 200,
		selModel : selModel,
		columns : [ {
			text : columnName,
			dataIndex : &#x27;fileName&#x27;,
			flex : 1
		} ],
		viewConfig : {
		}
	});
};

DataReductionForm.prototype._getFramesPanel = function() {
	var fields = [ &#x27;fileName&#x27;, &#x27;type&#x27;, &#x27;id&#x27; ];

	this.framesStore = Ext.create(&#x27;Ext.data.Store&#x27;, {
		fields : fields,
		sorters : &#x27;fileName&#x27;
	});

	this.averagesStore = Ext.create(&#x27;Ext.data.Store&#x27;, {
		fields : fields
	});

	this.subtractionStore = Ext.create(&#x27;Ext.data.Store&#x27;, {
		fields : fields
	});

	var gridFrames = this._getFramesExtPanel(this.framesStore, &quot;Frames&quot;, 375);
	var gridAvgs = this._getFramesExtPanel(this.averagesStore, &quot;Averages&quot;, 125);
	var subtractionAvgs = this._getFramesExtPanel(this.subtractionStore, &quot;Subtractions&quot;, 75);

	return {
		xtype : &#x27;container&#x27;,
		layout : &#x27;vbox&#x27;,
		items : [ gridFrames,  subtractionAvgs ]
	};
};

DataReductionForm.prototype._getImageContainer = function(name, help) {
	var html = &quot;&lt;div id=&#x27;&quot; + this.id + &quot;_&quot; + name + &quot;&#x27;&gt;&quot; + name + &quot;&lt;/div&gt;&quot;
	return {
		xtype : &#x27;container&#x27;,
		layout : &#x27;vbox&#x27;,
		items : [ {
			html : html,
			margin : &quot;5 0 0 0&quot;,
			height : 95,
			width : 100
		}, {
			xtype : &#x27;label&#x27;,
			forId : &#x27;myFieldId&#x27;,
			text : help,
			margin : &#x27;5 0 0 0&#x27;,
			cls : &quot;inline-help&quot;
		} ]
	}
};

DataReductionForm.prototype._getItems = function() {
	var _this = this;
	return [ {
		xtype : &#x27;container&#x27;,
		layout : &#x27;hbox&#x27;,
		items : [
				this._getFramesPanel(),
				this.plotWidget.getPanel(),
				{
					xtype : &#x27;panel&#x27;,
					width : 110,
					frame : true,
					margin : &quot;10 5 5 5&quot;,
					border : 0,
					layout : &#x27;vbox&#x27;,
					items : [ this._getImageContainer(&quot;scattering&quot;, &quot;Scattering&quot;), this._getImageContainer(&quot;guinier&quot;, &quot;Guinier Region&quot;),
							this._getImageContainer(&quot;kratky&quot;, &quot;Kratky Plot&quot;), this._getImageContainer(&quot;gnom&quot;, &quot;P(r) distribution&quot;) ]
				} ]
	} ]
};

DataReductionForm.prototype._getButtons = function() {
	return [];
};

DataReductionForm.prototype.getPanel = function() {
	var _this = this;
	this.panel = Ext.create(&#x27;Ext.form.Panel&#x27;, {
		width : this.width,
		height : this.height,
		border : 0,
		items : this._getItems(),
		buttons : this._getButtons(),
		listeners : {
			afterrender : function() {
				_this._populate();
			}
		}
	});
	return this.panel;
};

/** Populates could be call when the DOM is not filled yet **/
DataReductionForm.prototype._populate = function() {
};

/** It populates the form * */
DataReductionForm.prototype.refresh = function(subtractions) {
	if (subtractions != null) {
		for (var i = 0; i &lt; subtractions.length; i++) {
			/** Loading frame grids **/
			var subtraction = subtractions[i];
			var averages = [ {
				fileName : BUI.getFileName(subtraction.bufferAverageFilePath),
				type : &#x27;bufferAvg&#x27;,
				id : subtraction.subtractionId
			}, {
				fileName : BUI.getFileName(subtraction.sampleAverageFilePath),
				type : &#x27;sampleAvg&#x27;,
				id : subtraction.subtractionId
			}

			];
			this.averagesStore.loadData(averages, true);
			this.subtractionStore.loadData([ {
				fileName : BUI.getFileName(subtraction.substractedFilePath),
				type : &#x27;SUBTRACTION&#x27;,
				id : subtraction.subtractionId
			} ], true);

			var frames = [];
			/** Buffers **/
			if (subtraction.bufferOneDimensionalFiles != null) {
				if (subtraction.bufferOneDimensionalFiles.frametolist3VOs != null) {
					for (var j = 0; j &lt; subtraction.bufferOneDimensionalFiles.frametolist3VOs.length; j++) {
						var frametolist3VO = subtraction.bufferOneDimensionalFiles.frametolist3VOs[j];
						if (frametolist3VO.frame3VO != null) {
							frames.push({
								fileName : BUI.getFileName(frametolist3VO.frame3VO.filePath),
								type : &#x27;BUFFER&#x27;,
								id : frametolist3VO.frame3VO.frameId
							});
						}
					}
				}
			}
			/** Samples **/
			if (subtraction.sampleOneDimensionalFiles != null) {
				if (subtraction.sampleOneDimensionalFiles.frametolist3VOs != null) {
					for (var j = 0; j &lt; subtraction.sampleOneDimensionalFiles.frametolist3VOs.length; j++) {
						var frametolist3VO = subtraction.sampleOneDimensionalFiles.frametolist3VOs[j];
						if (frametolist3VO.frame3VO != null) {
							frames.push({
								fileName : BUI.getFileName(frametolist3VO.frame3VO.filePath),
								type : &#x27;SAMPLE&#x27;,
								id : frametolist3VO.frame3VO.frameId
							});
						}
					}
				}
			}

			this.framesStore.loadData(frames, true);

			/** Loading images **/
			this._displayImage(&quot;scattering&quot;, subtraction.subtractionId);
			this._displayImage(&quot;kratky&quot;, subtraction.subtractionId);
			this._displayImage(&quot;guinier&quot;, subtraction.subtractionId);
			this._displayImage(&quot;gnom&quot;, subtraction.subtractionId);
		}
	}
};

DataReductionForm.prototype._displayImage = function(name, subtractionId) {
//	var url = BUI.getURL() + &#x27;&amp;type=&#x27; + name + &#x27;&amp;subtractionId=&#x27; + subtractionId;
	var url = new DataAdapter().getImage(subtractionId, name);
	console.log(url);
	var event = &quot;OnClick= window.open(&#x27;&quot; + url + &quot;&#x27;)&quot;;
//	name
	document.getElementById(this.id + &quot;_&quot; + name).innerHTML = &#x27;&lt;img src=&#x27; + url + &#x27;   height=&quot;90&quot; width=&quot;90&quot; &#x27; + event + &#x27;&gt;&#x27;;
//	return &#x27;&lt;img src=&#x27; + url + &#x27;   height=&quot;100&quot; width=&quot;100&quot; &gt;&#x27;;
};

DataReductionForm.prototype.input = function() {
	return {};
};

/** It populates the form **/
DataReductionForm.prototype.test = function(targetId) {
	var macromoleculeForm = new DataReductionForm();
	var panel = macromoleculeForm.getPanel();
	panel.render(targetId);
};

//
//function PlotWidget(args) {
//	this.width = 600;
//	this.height = 600;
//	this.id = BUI.id();
//
//	this.linear = false;
//
//	this.margin =  &quot;10 0 0 0&quot;;
//	/** for each stat the max and minimum value when it is scaled in order to show correctly in the legend **/
//	this.ranges = {};
//	if (args != null) {
//		if (args.width != null) {
//			this.width = args.width;
//		}
//		if (args.height != null) {
//			this.height = args.height;
//		}
//		if (args.margin != null) {
//			this.margin = args.margin;
//		}
//	}
//
//}
//
//PlotWidget.prototype.getMenu = function() {
//	var _this = this;
//	/** Actions buttons **/
//	var actions = [];
//	actions.push(&quot;-&gt;&quot;);
//	actions.push({
//		text : &quot;Export as Image&quot;,
//		scope : this,
//		icon : &#x27;../images/save.gif&#x27;,
//		handler : function(item, pressed) {
//			var largeImage = document.createElement(&quot;img&quot;);
//			largeImage.style.display = &#x27;block&#x27;;
//			largeImage.style.width = 200 + &quot;px&quot;;
//			largeImage.style.height = 200 + &quot;px&quot;;
//			largeImage.setAttribute(&#x27;src&#x27;, Dygraph.Export.asCanvas(this.dygraphObject.dygraph).toDataURL());
//			window.open(Dygraph.Export.asCanvas(this.dygraphObject.dygraph).toDataURL(), &#x27;Image&#x27;, &#x27;&#x27;);
//		}
//	});
//
//	return actions;
//};
//
///** Looks for the maximum value and then divide everything but that value **/
//PlotWidget.prototype.scaledData = function(data) {
//	for (var i = 0; i &lt; data.length; i++) {
//		var values = this.getMaxAndMinValue(data[i]);
//		data[i] = this.divideValuesByMax(data[i], values.max);
//		this.ranges[data[i].label] = values;
//	}
//	return data;
//};
//
///** Given a stat float[] and a max number it will divide each value by max **/
//PlotWidget.prototype.divideValuesByMax = function(stat, max) {
//	for (var j = 0; j &lt; stat.data.length; j++) {
//		if (max != 0) {
//			stat.data[j] = Number(stat.data[j]) / max;
//			stat.std[j] = Number(stat.std[j]) / max;
//		}
//	}
//	return stat;
//};
//
///** returns max value of a stat **/
//PlotWidget.prototype.getMaxAndMinValue = function(stat) {
//	var max = 0;
//	var min = stat.data[0];
//	for (var j = 0; j &lt; stat.data.length; j++) {
//		if (Number(stat.data[j]) &gt; max) {
//			max = Number(stat.data[j]);
//		}
//		if (Number(stat.std[j]) &gt; max) {
//			max = Number(stat.std[j]);
//		}
//		if (Number(stat.data[j]) &lt; min) {
//			min = Number(stat.data[j]);
//		}
//	}
//	return {
//		max : Number(max),
//		min : Number(min)
//	};
//};
//
//PlotWidget.prototype._renderDygraph = function(parsed, colors, labels) {
//	this.dygraphObject = new StdDevDyGraph(this.id, {
//		width : this.width - 20,
//		height : this.height - 40,
//		xlabel : &quot;&quot;,
//	});
//
//	this.dygraphObject.draw(parsed, colors, labels);
//
//};
//
//PlotWidget.prototype.getPanel = function() {
//	this.panel = Ext.create(&#x27;Ext.panel.Panel&#x27;, {
//		width : this.width,
//		height : this.height,
//		margin : this.margin,
//		tbar : this.getMenu(),
//		items : [ {
//			html : &quot;&quot;,
//			id : this.id,
//			width : this.width,
//			height : this.height,
//			padding : 10,
//			margin : &quot;0 0 0 -30&quot;,
//			border : 0
//		} ]
//	});
//
//	return this.panel;
//};
//
//PlotWidget.prototype.getPoint = function(y, error) {
//	var minus = y - error;
//	var max = y + error;
//
//	if (this.linear) {
//		return [ Math.abs(minus), y, Math.abs(max) ];
//	}
//	if ((minus != 0) &amp;&amp; (max != 0)) {
//		return [ Math.log(Math.abs(minus)), Math.log(y), Math.log(Math.abs(max)) ];
//	} else {
//		return [ Math.log(y), Math.log(y), Math.log(y) ];
//	}
//
//};
//
//PlotWidget.prototype.getDataPlot = function(frames, subtractions, models, fits, rbms) {
//	var files = [];
//	var labels = [ &quot;Intensity&quot; ];
//	if (frames != null) {
//		for (var i = 0; i &lt; frames.length; i++) {
//			files.push(frames[i].data);
//			labels.push(frames[i].fileName);
//		}
//	}
//	 function splitData(data, column, errorColumn, name){
//		 var result = []
//		 for (var j = 0; j &lt; data.length; j++) {
//			 console.log(data[j][column]);
//			result.push([j,data[j][column],data[j][errorColumn]]);//[0, data[i][column],0]]);
//		}
//		 files.push(result);
//		 labels.push(name);
//	 }
//	 
//	if (subtractions != null) {
//		for (var i = 0; i &lt; subtractions.length; i++) {
//			/** For subtraction **/
//			files.push(subtractions[i].subtraction.data);
//			labels.push(subtractions[i].subtraction.fileName);
//			/** For sample average **/
////			files.push(subtractions[i].sampleAvg.data);
////			labels.push(subtractions[i].sampleAvg.fileName);
//			/** For buffer average **/
////			files.push(subtractions[i].bufferAvg.data);
////			labels.push(subtractions[i].bufferAvg.fileName);
//		}
//	}
//	
//	if (models != null) {
//		for (var i = 0; i &lt; models.length; i++) {
//			for ( var key in models[i]) {
//				 splitData(models[i][key].fir.data, 1, 2, &quot;Intensity&quot;);
//				 splitData(models[i][key].fir.data, 3, 3, &quot;Fit&quot;);
//			}
//		}
//	}
//	
//	if (fits != null) {
//		for (var i = 0; i &lt; fits.length; i++) {
//			for ( var key in fits[i]) {
//				
//				/** adding fit file to be plotted **/
//						 if (fits[i][key].fit.data[0].length == 3){
//							 splitData(fits[i][key].fit.data, 1, 1, &quot;Intensity&quot;);
//							 splitData(fits[i][key].fit.data, 2, 2, &quot;Fit&quot;);
//						 }
//						 
//						 if (fits[i][key].fit.data[0].length == 5){
//							 /** X Intensity Fit Error Residues **/
//							
//							 splitData(fits[i][key].fit.data, 1, 3, &quot;Intensity&quot;);
//							 splitData(fits[i][key].fit.data, 2, 2, &quot;Fit&quot;);
//						 }
//			}
//		}
//	}
//	
//	var dataPoints = [];
//	if (files.length &gt; 0) {
//		for (var i = 0; i &lt; files[0].length; i++) {
//			dataPoints.push([ files[0][i][0], this.getPoint(files[0][i][1], files[0][i][2]) ]);
//		}
//		if (files.length &gt; 1) {
//			for (var i = 1; i &lt; files.length; i++) {
//				for (var j = 0; j &lt; dataPoints.length; j++) {
//					if (files[i][j] != null){
//						dataPoints[j].push(this.getPoint(files[i][j][1], files[i][j][2]));
//					}
//					else{
//						dataPoints[j].push([0,0,0]);
//					}
//				}
//			}
//		}
//	}
//
//	return {
//		dataPoints : dataPoints,
//		labels : labels
//	};
//};
//
//PlotWidget.prototype.refresh = function(frames, subtractions, models, fits, rbms, colors) {
//	var _this = this;
////	this.panel.setLoading(&quot;Reading Files&quot;);
////	
////	var dataAdapter = new BiosaxsDataAdapter();
////	dataAdapter.onSuccess.attach(function(sender, data) {
////			_this.panel.setLoading(&quot;Rendering&quot;);
////			var parsed = _this.getDataPlot(data.frames, data.subtractions, data.models, data.fits, rbms);
////			_this._renderDygraph(parsed.dataPoints, colors, parsed.labels);
////		_this.panel.setLoading(false);
////	});
////	dataAdapter.onError.attach(function(sender, data) {
////		_this.panel.setLoading(false);
////	});
////	dataAdapter.getDataPlot(frames, subtractions, models, fits, rbms);
//};
//
//PlotWidget.prototype.input = function() {
//	return DATADOC.getHPLCData();
//};

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
