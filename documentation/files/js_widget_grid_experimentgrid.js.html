<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js/widget/grid/experimentgrid.js - EXI</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="EXI" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AutoProcIntegrationGrid.html">AutoProcIntegrationGrid</a></li>
                                <li><a href="../classes/ManagerWelcomeMainView.html">ManagerWelcomeMainView</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: js/widget/grid/experimentgrid.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">

/**
 *  Shows a list of experiment AKA data acquisitions
 *	@height
 *	@sorters 
 *	@minHeight
 *	@gridType: Ext.ux.LiveSearchGridPanel or Ext.grid.Panel
 *	@tbar true or false
 *	@grouping true or false
 *	@width
 *	@title
 *	#onEditButtonClicked
 */
function ExperimentGrid(args) {
	this.width = &quot;100%&quot;;
	this.height = 700;
	this.minHeight = 500;

	this.id =  BUI.id();
	this.gridType = &#x27;Ext.grid.Panel&#x27;; //&#x27;Ext.ux.LiveSearchGridPanel&#x27;;
	this.tbar = false;
	this.hideHeaders = false;
	this.grouping = true;
	this.title = null;

	this.filtered = null;
	
	/** maximum row count **/
	this.limit = 100;
	
	this.sessionIdFilter = null;
	
	/** if not null filtered by date **/
	this.date = null;
	
	this.sorters = [ {
		property : &#x27;date&#x27;,
		direction : &#x27;DESC&#x27;
	}, {
		property : &#x27;time&#x27;,
		direction : &#x27;DESC&#x27;
	} ];

	this.dates = {};
	if (args != null) {
		if (args.height != null) {
			this.height = args.height;
		}
		if (args.limit != null) {
			this.limit = args.limit;
		}
		if (args.sorters != null) {
			this.sorters = args.sorters;
		}
		if (args.sessionId != null){
			this.sessionIdFilter = args.sessionId;
		}
		if (args.filtered != null) {
			this.filtered = args.filtered;
		}
		if (args.minHeight != null) {
			this.minHeight = args.minHeight;
		}
		if (args.gridType != null) {
			this.gridType = args.gridType;
		}
		if (args.tbar != null) {
			this.tbar = args.tbar;
		}
		if (args.grouping != null) {
			this.grouping = args.grouping;
		}
		if (args.width != null) {
			this.width = args.width;
		}
		if (args.title != null) {
			this.title = args.title;
		}

	}
	/** Events **/
	this.onEditButtonClicked = new Event(this);
}

ExperimentGrid.prototype._getFilterTypes = function() {
	return [];
};

ExperimentGrid.prototype._prepareData = function(rows) {
	var data = [];
	var count = 0;
	
	rows.sort(function(a,b){return b.experimentId - a.experimentId;});
	for ( var i = 0; i &lt; rows.length; i++) {
	var row = rows[i];
				this.dates[moment(row.creationDate).format(&quot;YYYYMMDD&quot;)] = moment(row.creationDate).format(&quot;MMM Do YY&quot;);
				if (
						  ( this.filtered == null || row.experimentType == this.filtered ) &amp;&amp; (count &lt; this.limit || this.limit == null )	&amp;&amp; (this.sessionIdFilter == null || this.date != null || (this.date == null &amp;&amp; this.sessionIdFilter == row.sessionId)) 
					){

					data.push({
						experimentId : row.experimentId,
						status : row.status,
						dataAcquisitionFilePath : row.dataAcquisitionFilePath,
						type : row.experimentType,
						name : row.name,
						macromolecules_names : row.macromolecules,
						percentageAnalysed : {
							value : (row.dataCollectionDoneCount / row.dataCollectionCount) * 100,
							text : row.dataCollectionDoneCount + &quot; of &quot; + row.dataCollectionCount
						},
						percentageCollected : {
							value : (row.measurementDoneCount / row.measurementCount) * 100,
							text : row.measurementDoneCount + &quot; of &quot; + row.measurementCount
						},
						percentageMerged : {
							value : (row.measurementAveragedCount / row.measurementCount) * 100,
							text : row.measurementAveragedCount + &quot; of &quot; + row.measurementCount
						},
						date : moment(row.creationDate).format(&quot;YYYYMMDD&quot;),
						time : moment(row.creationDate).format(&quot;YYYYMMDDHHmmss&quot;),
						creationDate : row.creationDate
					});
					count ++;
		}
	}
	return data;
};

ExperimentGrid.prototype.getPanel = function(experiments) {
	this.features = experiments;
	return this._renderGrid(experiments);
};

ExperimentGrid.prototype.refresh = function(experiments) {
	
	this.experiments = experiments;
	var filtered = [];
	for ( var i = 0; i &lt; experiments.length; i++) {
		if (experiments[i].experimentType != &quot;TEMPLATE&quot;) {
			filtered.push(experiments[i]);
		}
	}

	this.parsedData = this._prepareData(filtered);
	
	var day = {};
	var dates = [];
	for ( var i = 0; i &lt; this.experiments.length; i++) {
		var date  =  moment(this.experiments[i].creationDate).format(&quot;MMM Do YYYY&quot;);
		if (day[date] == null){
			dates.push({
				date : date,
				value :  moment(this.experiments[i].creationDate)
			});
			day[date] = true;
		}
	}
	
	this.storeDate.loadData(dates, false);
	this.store.loadData(this.parsedData, false);
	
	/** If it has already been filtered by date we keep the filter **/
	if (this.date != null){
		this._filterByDate(this.date);
	}
	
};

ExperimentGrid.prototype._getTopButtons = function() {
	var _this = this;
	/** Actions buttons **/
	var actions = [];

	actions.push(Ext.create(&#x27;Ext.Action&#x27;, {
		icon : &#x27;../images/calendar_icon.png&#x27;,
		text : &#x27;Show Calendar&#x27;,
		disabled : false,
		handler : function(widget, event) {
			var window = Ext.create(&#x27;Ext.window.Window&#x27;, {
				title : &#x27;Calendar&#x27;,
				width : 600,
				height : 600,
				modal : true,
				closable : true,
				layout : {
					type : &#x27;vbox&#x27;,
					align : &#x27;stretch&#x27;
				},
				items : [ {
					xtype : &#x27;label&#x27;,
					html : &#x27;Click on a data acquisition to select:&#x27;,
					margin : &#x27;5 5 5 5&#x27;
				}, {
					html : &#x27;&lt;div id=&quot;calendar&quot; style=&quot;height:450px;overflow-y: scroll;&quot;&gt;&lt;/div&gt;&#x27;,
					margin : &#x27;5 5 5 5&#x27;
				}

				]
			}).show();

			var calendarWidget = new CalendarWidget({
				height : 450
			});
			var aux = _this.limit;
			/** we remove the limit temporarily **/
			_this.limit = null;
			_this.sessionIdFilter = null;
			calendarWidget.loadData(_this._prepareData(_this.experiments));
			_this.limit = aux;
			calendarWidget.draw(&#x27;calendar&#x27;);
			calendarWidget.onClick.attach(function(sender, date) {
				date = moment(date, &quot;YYYY-MM-DD&quot;);
				_this._filterByDate(date);
				window.close();
				
			});

		}
	}));
	this.storeDate =  Ext.create(&#x27;Ext.data.ArrayStore&#x27;, {
		        fields: [&#x27;date&#x27;, &#x27;value&#x27;],
		        data : []
		    });
	
	this.dateMenu = Ext.create(&#x27;Ext.form.field.ComboBox&#x27;, {
	        hideLabel: true,
	        store: this.storeDate,
	        displayField: &#x27;date&#x27;,
	        typeAhead: true,
	        queryMode: &#x27;local&#x27;,
	        margin : &#x27;0 0 0 30&#x27;,
	        triggerAction: &#x27;all&#x27;,
	        emptyText:&#x27;Select a date...&#x27;,
	        selectOnFocus:true,
	        width:135,
	        listeners:{
	            scope: this,
	            &#x27;select&#x27;: function (a,b,c){
	            	_this.limit = null;
	            	_this._filterByDate(moment(b[0].raw.value, &quot;YYYY-MM-DD&quot;));
	            }
	       }
	 });
	 
	actions.push(this.dateMenu);
	
	actions.push(&quot;-&gt;&quot;);
	if (_this.filtered != null){
		actions.push({
			html	: &quot;&lt;span&gt;Experiment Type: &quot; + _this.filtered +&quot;&lt;/span&gt;&quot;
		});
	}
	else{
		actions.push({
			html	: &quot;&lt;span&gt;Experiment Type: ALL&lt;/span&gt;&quot;
		});
	}
	return actions;
};

/**
 * Date format: &quot;YYYY-MM-DD&quot;
 */
ExperimentGrid.prototype._filterByDate = function(date) {
	var experimentsFiltered = [];
	/** Getting all the experiments of date**/
	for ( var i = 0; i &lt; this.experiments.length; i++) {
		var experiment = this.experiments[i];
		if (experiment.creationDate != null) {
			var experimentDate = moment(experiment.creationDate);
			if (experimentDate.year() == date.year()) {
				if (experimentDate.month() == date.month()) {
					if (experimentDate.date() == date.date()) {
						experimentsFiltered.push(experiment);
					}
				}
			}
		}
	}
	var parsedData = this._prepareData(experimentsFiltered);
	this.store.loadData(parsedData);
	this.date = date;
};

/** Only for templates **/
ExperimentGrid.prototype._removeExperimentById = function(experimentId) {
	var _this = this;
	var adapter = new BiosaxsDataAdapter();
	adapter.onSuccess.attach(function(evt, args) {
		_this.grid.setLoading(false);
		document.getElementById(BIOSAXS.targetId).innerHTML = &quot;&quot;;
		BIOSAXS.start(BIOSAXS.targetId);
	});
	this.grid.setLoading(&quot;Removing experiment &quot;);
	adapter.removeExperimentById(experimentId);
};

ExperimentGrid.prototype._renderGrid = function() {
	var _this = this;

	/** Store **/
	this.store = Ext.create(&#x27;Ext.data.Store&#x27;, {
		fields : [&quot;name&quot;], 
//		groupField : &#x27;date&#x27;,
		autoload : true,
		data : [],
		remoteSort: false,
		sorters : this.sorters
	});

	
	
	
	var groupingFeature = Ext.create(&#x27;Ext.grid.feature.Grouping&#x27;, {
		groupHeaderTpl : Ext.create(&#x27;Ext.XTemplate&#x27;,
				&quot;&lt;div style=&#x27;background:#0ca3d2; color:white; float:left; margin:6px 8px 0 0; padding:5px 8px;&#x27;&gt;{name:this.formatName}&lt;/div&gt;&quot;, {
					formatName : function(name) {
						return _this.dates[name];
					}
				}),
		hideGroupedHeader : true,
		startCollapsed : false
	});

	this.features = [];
	if (this.grouping) {
		this.features.push(groupingFeature);
	}

	/** Grid **/
	this.grid = Ext.create(this.gridType, {
		hideHeaders : this.hideHeaders,
		resizable : true,
		title : this.title,
		width : this.width,
		minHeight : this.minHeight,
		height : this.height,
		features : this.features,
		store : this.store,
		columns : this._getColumns(),
		selModel : {
			mode : &#x27;SINGLE&#x27;
		},
		viewConfig : {
			stripeRows : true,
			getRowClass : function(record, rowIdx, params, store) {
				if (record.raw.type == &quot;TEMPLATE&quot;) {
					return &quot;template-color-row&quot;;
				}
				if ((record.raw.type == &quot;CALIBRATION&quot;) &amp;&amp; (record.raw.status == &quot;FINISHED&quot;)) {
					return &quot;blue-row&quot;;
				}
			},
			listeners : {
				itemdblclick : function(dataview, record, item, e) {
					_this._editExperiment(record.raw.experimentId);
				},
				cellclick : function(grid, td, cellIndex, record, tr, rowIndex, e, eOpts) {
					if (grid.getGridColumns()[cellIndex].getId() == _this.id + &#x27;GO&#x27;) {
						_this._editExperiment(record.raw.experimentId);
					}

					if (grid.getGridColumns()[cellIndex].getId() == _this.id + &#x27;REMOVE&#x27;) {
						_this._removeExperimentById(record.raw.experimentId);
					}

				}
			}
		}
	});

	var actions = _this._getTopButtons();

	if (this.tbar) {
		this.grid.addDocked({
			xtype : &#x27;toolbar&#x27;,
			height : 48,
			items : actions
		});
		this.grid.getSelectionModel().on({
			selectionchange : function(sm, selections) {
				if (selections.length) {
					for ( var i = 0; i &lt; actions.length; i++) {
						if (actions[i].enable) {
							actions[i].enable();
						}
					}
				} else {
					for ( var i = 0; i &lt; actions.length; i++) {
						if (actions[i].alwaysEnabled == false) {
							if (actions[i].disable) {
								actions[i].disable();
							}
						}
					}
				}
			}
		});
	}

	return this.grid;
};

ExperimentGrid.prototype._getColumns = function() {
	var _this = this;
	function actionItemRenderer(value, meta, record, rowIx, ColIx, store) {
		if (record.raw.buffer3VOs != null) {
			if (record.raw.buffer3VOs.length &gt; 0) {
				return &#x27;x-hide-display&#x27;;
			}
		}

		if (record.data.platesCount &gt; 0) {
			return &#x27;x-hide-display&#x27;;
		}
	}

	return [
		{
			text : &#x27;experimentId&#x27;,
			dataIndex : &#x27;experimentId&#x27;,
			name : &#x27;experimentId&#x27;,
			type : &#x27;string&#x27;,
			hidden : true
		},
		{
			xtype : &#x27;rownumberer&#x27;,
			width : 40
		},
		{
			text : &#x27;Name&#x27;,
			dataIndex : &#x27;name&#x27;,
			name : &#x27;name&#x27;,
			type : &#x27;string&#x27;,
			flex : 1
		},

		{
			text : &#x27;Type&#x27;,
			dataIndex : &#x27;type&#x27;,
			name : &#x27;type&#x27;,
			type : &#x27;string&#x27;,
			flex : 1,
			renderer : function(val) {
				if (val == &quot;CALIBRATION&quot;) {
					return &quot;&lt;span style=&#x27;color:blue;&#x27;&gt;&quot; + val + &quot;&lt;/span&gt;&quot;;
				}

				return val;
			}
		},
		{
			text : &#x27;Macromolecules&#x27;,
			name : &#x27;macromolecules_names&#x27;,
			dataIndex : &#x27;macromolecules_names&#x27;,
			flex : 1,
			renderer : function(val) {
				if (val != null) {
					return &quot; &lt;span style=&#x27;font-weight:bold&#x27;&gt;&quot; + val + &quot;&lt;/span&gt;&quot;;
				}
				return &quot; &lt;span style=&#x27;font-style:italic;color:gray;&#x27;&gt;Information not available&lt;/span&gt;&quot;;
			}
		},
		{
			text : &#x27;Buffers&#x27;,
			dataIndex : &#x27;buffer_names&#x27;,
			name : &#x27;buffer_names&#x27;,
			flex : 1,
			hidden : true,
			renderer : function(val) {
				return &quot;Buffer/s: &lt;span style=&#x27;font-weight:bold&#x27;&gt;&quot; + val + &quot;&lt;/span&gt;&quot;;
			}
		},
		{
			text : &#x27;Status&#x27;,
			dataIndex : &#x27;status&#x27;,
			name : &#x27;status&#x27;,
			type : &#x27;string&#x27;,
			flex : 1,
			renderer : function(val, x, sample) {
				if (sample.raw.type == &quot;TEMPLATE&quot;) {
					return &quot;READY&quot;;
				}
				if (sample.raw.status == &quot;ABORTED&quot;) {
					return &quot;&lt;span style=&#x27;color:red;&#x27;&gt;&quot; + val + &quot;&lt;/span&gt;&quot;;
				}
				return &quot;&lt;span style=&#x27;color:green;&#x27;&gt;&quot; + val + &quot;&lt;/span&gt;&quot;;
			}
		},
		{
			text : &#x27;Download&#x27;,
			dataIndex : &#x27;creationDate&#x27;,
			name : &#x27;creationDate&#x27;,
			renderer : function(val, x, sample) {
				if (sample != null) {
					if (sample.raw.type == &quot;HPLC&quot;) {
						return;
					}
					return BUI.getZipHTMLByExperimentId(sample.raw.experimentId, sample.raw.name);
				}
			},
			width : 100

		},
		{
			header : &#x27;Measurements&#x27;,
			dataIndex : &#x27;percentageCollected&#x27;,
			name : &#x27;percentageCollected&#x27;,
			type : &#x27;string&#x27;,
			renderer : function(val, y, sample) {
				if ((sample.raw.type == &quot;TEMPLATE&quot;) || (sample.raw.type == &quot;HPLC&quot;)) {
					return;
				}
				return &quot;&lt;table&gt;&lt;tr&gt;&lt;td&gt;&quot; + BUI.getProgessBar(sample.raw.percentageCollected.value, sample.raw.percentageCollected.text) + &quot;&lt;/td&gt;&lt;/table&gt;&quot;;
			},
			width : 100
		},
		{
			header : &#x27;Averaged&#x27;,
			dataIndex : &#x27;percentageMerged&#x27;,
			name : &#x27;percentageMerged&#x27;,
			type : &#x27;string&#x27;,
			renderer : function(val, y, sample) {
				if ((sample.raw.type == &quot;TEMPLATE&quot;) || (sample.raw.type == &quot;HPLC&quot;)) {
					return;
				}
				return &quot;&lt;table&gt;&lt;tr&gt;&lt;td&gt;&quot; + BUI.getProgessBar(sample.raw.percentageMerged.value, sample.raw.percentageMerged.text) + &quot;&lt;/td&gt;&lt;/table&gt;&quot;;
			},
			width : 100
		},
		{
			header : &#x27;Subtractions&#x27;,
			dataIndex : &#x27;percentageAnalysed&#x27;,
			name : &#x27;percentageAnalysed&#x27;,
			type : &#x27;string&#x27;,
			renderer : function(val, y, sample) {
				if ((sample.raw.type == &quot;TEMPLATE&quot;) || (sample.raw.type == &quot;HPLC&quot;)) {
					return;
				}
				return &quot;&lt;table&gt;&lt;tr&gt;&lt;td&gt;&quot; + BUI.getProgessBar(sample.raw.percentageAnalysed.value, sample.raw.percentageAnalysed.text) + &quot;&lt;/td&gt;&lt;/table&gt;&quot;;
			},
			width : 100
		},

		{
			text : &#x27;time&#x27;,
			dataIndex : &#x27;time&#x27;,
			name : &#x27;time&#x27;,
			hidden : true,
			renderer : function(val) {
				return val;
			},
			width : 100

		}, {
			text : &#x27;Date&#x27;,
			dataIndex : &#x27;date&#x27;,
			name : &#x27;date&#x27;,
			renderer : function(val) {
				return val;
			},
			width : 100

		},

		{
			text : &#x27;Time&#x27;,
			dataIndex : &#x27;creationDate&#x27;,
			name : &#x27;creationDate&#x27;,
			renderer : function(val) {
				return moment(val).format(&quot; HH:mm:ss&quot;);
			},
			width : 100

		}, {
			id : _this.id + &#x27;GO&#x27;,
			width : 80,
			sortable : false,
			renderer : function(value, metaData, record, rowIndex, colIndex, store) {
				return BUI.getGreenButton(&#x27;GO&#x27;);
			}
		} ];
};

/** Changes location.href in order to edit the experiment **/
ExperimentGrid.prototype._editExperiment = function(experimentId) {
	if (Ext.urlDecode(window.location.href).sessionId != null) {
		location.href = &#x27;viewProjectList.do?reqCode=display&amp;experimentId=&#x27; + experimentId + &#x27;&amp;sessionId=&#x27;+ Ext.urlDecode(window.location.href).sessionId;
	} else {
		location.href = &#x27;viewProjectList.do?reqCode=display&amp;experimentId=&#x27; + experimentId;
	}
};

ExperimentGrid.prototype.input = function() {
	var experiments = DATADOC.getExperimentList_10();
	return {
		experiments : experiments,
		proposal : new MeasurementGrid().input().proposal

	};
};

ExperimentGrid.prototype.test = function(targetId) {
	var experimentGrid = new ExperimentGrid({
		height : 350,
		minHeight : 350,
		width : 1000

	});
	BIOSAXS.proposal = new Proposal(experimentGrid.input().proposal);
	var panel = experimentGrid.getPanel(experimentGrid.input().experiments);
	experimentGrid.refresh(experimentGrid.input().experiments);
	panel.render(targetId);
};

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
