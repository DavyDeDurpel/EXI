<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js/main/userwelcomemainview.js - EXI</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="EXI" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ManagerWelcomeMainView.html">ManagerWelcomeMainView</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: js/main/userwelcomemainview.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
function UserWelcomeMainView() {
	this.icon = &#x27;../images/icon/rsz_ic_home_black_24dp.png&#x27;;

	MainView.call(this);
	this.title = &quot;Home&quot;;
	this.closable = false;
	
	
	this.proposalGrid = new ProposalGrid({
		height : 300
	});
	
	var _this = this;
	this.proposalGrid.onSelected.attach(function(sender, proposal){
		_this.panel.setLoading(true);
		_this.activeProposal(proposal);
		_this.panel.setLoading(false);
	});
	
	this.todaySessionsGrid = new SessionGrid(
			{
				width : null,
				height : 125,
				title : &quot;You have got sessions scheduled for today&quot;,
				hiddenGoColumn : false
			}
	);
	
	this.futureSessionsGrid = new SessionGrid(
			{
				width : null,
				height : 450,
				title : &quot;Next scheduled sessions&quot;,
				margin : &quot;20 0 0 00&quot;,
			}
	);
	
	this.previousSessionsGrid = new SessionGrid(
			{
				width : null,
				height : 450,
				title : &quot;Previous sessions&quot;,
				margin : &quot;20 0 0 10&quot;,
				hiddenGoColumn : false
			}
	);

	
	EXI.credentialManager.onActiveProposalChanged.attach(function(sender, proposal){
//		debugger
//		_this.mainMenu.populateCredentialsMenu();
	});
//	EXI.proposalManager.onActiveProposalChanged = function(sender, proposal){
//		debugger
//		
//	};
//	
}

UserWelcomeMainView.prototype.getPanel = MainView.prototype.getPanel;
UserWelcomeMainView.prototype.getContainer = MainView.prototype.getContainer;


UserWelcomeMainView.prototype.activeProposal = function(proposal) {
	EXI.credentialManager.setActiveProposal(this.username, proposal.Proposal_proposalCode + proposal.Proposal_proposalNumber);
	EXI.proposalManager.get(true);
};

UserWelcomeMainView.prototype.getContainer = function() {

		this.panel =  Ext.createWidget(&#x27;tabpanel&#x27;,
		{
			plain : true,
			margin : &#x27;20 10 10 10&#x27;,
			items : [

				{
					tabConfig : {
						title : &#x27;Sessions&#x27;,
						
					},
					listeners : {
						afterrender : function(){
//							var cal = CALENDAR();
//							cal.init();
						}
					},
					items : [ {
						xtype : &#x27;container&#x27;,
						id : this.id + &quot;sessions&quot;,
						layout : &#x27;fit&#x27;,
						padding : 10,
						style : {
							borderColor : &#x27;gray&#x27;,
							borderStyle : &#x27;solid&#x27;,
							borderWidth : &#x27;1px&#x27;,
							&#x27;background-color&#x27; : &#x27;white&#x27; 
						},
						items : [
						         {
									 	html : &quot;&lt;div&gt;Where is my beamline? &lt;a target=&#x27;blank&#x27; href=&#x27;http://www.esrf.eu/files/live/sites/www/files/UsersAndScience/Experiments/Beamlines/beamlines-2015.jpg&#x27;&gt;Here there is a map&lt;/a&gt;&lt;/div&gt;&quot;,
									 	height : 20
							     },
						         {
						        	 xtype : &#x27;container&#x27;,
						        	 layout : &#x27;hbox&#x27;,
						        	 items : [
						        	          		this.futureSessionsGrid.getPanel(),
						        	          		this.previousSessionsGrid.getPanel()
				        	          ]
						         }
						      
						]
					}

					]
				},
				{
					tabConfig : {
						title : &#x27;Proposals&#x27;,
						
					},
					items : [ {
						xtype : &#x27;container&#x27;,
						layout : &#x27;fit&#x27;,
						height : 700,
						padding : 20,
						style : {
							borderColor : &#x27;gray&#x27;,
							borderStyle : &#x27;solid&#x27;,
							borderWidth : &#x27;1px&#x27;,
							&#x27;background-color&#x27; : &#x27;white&#x27; 
						},
						items : [ 
						         
						         this.proposalGrid.getPanel()
						]
					}

					]
				}
		]});
		
		this.panel.on(&quot;afterrender&quot;, function(){
		});
		return this.panel;
};


UserWelcomeMainView.prototype.parseSessionsByDate = function(sessions) {
	var olderSessions = [];
	var futureSessions = [];
	var todaySessions = [];
	
	
	for (var i = 0; i &lt; sessions.length; i++) {
		/** Older **/
		sessions[i].diff = moment(sessions[i].startDate).diff(moment(), &#x27;days&#x27;);
		if (sessions[i].diff == 0){
			todaySessions.push(sessions[i]);
		}
		else{
			if (sessions[i].diff &lt; 0){
				olderSessions.push(sessions[i]);
			}
			else{
				futureSessions.push(sessions[i]);
			}
		}
	}
	
	futureSessions.sort(function(a, b){
		return a.diff - b.diff;
	});
	
	return {
		olderSessions : olderSessions,
		futureSessions : futureSessions,
		todaySessions : todaySessions
	};
};


UserWelcomeMainView.prototype.loadProposal = function(proposals) {
	var _this = this;
	
	function onSessions(sender, sessions){
			_this.panel.setLoading(false);
			var mySessions = _this.parseSessionsByDate(sessions);
			if (mySessions.olderSessions.length &gt; 0){
				console.log(mySessions.olderSessions);
				_this.previousSessionsGrid.load(mySessions.olderSessions);
			}
			
			if (mySessions.futureSessions.length &gt; 0){
				_this.futureSessionsGrid.load(mySessions.futureSessions);
			}
			
			if (mySessions.todaySessions.length &gt; 0){
				Ext.getCmp(_this.id + &quot;sessions&quot;).insert(0, _this.todaySessionsGrid.getPanel());
				_this.todaySessionsGrid.load(mySessions.todaySessions);
			}
			
	}
		
		
	for (var i = 0; i &lt; proposals.length; i++) {
		_this.activeProposal(proposals[i]);
		_this.panel.setLoading(&quot;Loading Sessions&quot;);
		EXI.getDataAdapter({onSuccess:onSessions}).proposal.session.getSessions();
	}
};

UserWelcomeMainView.prototype.loadUserView = function() {
	var _this = this;
	this.panel.setLoading(&quot;Loading Proposal&quot;);
	var onSuccess = function(sender, proposals){
		proposals.sort(function(a, b)
		{
		  return a[&quot;Proposal_proposalId&quot;] - b[&quot;Proposal_proposalId&quot;];
		});
	
		
		_this.proposalGrid.load(proposals);
		console.log(proposals);
		if (proposals.length&gt; 0){
			_this.loadProposal(proposals);
		}
	};
	EXI.proposalManager.get();
	EXI.getDataAdapter({onSuccess:onSuccess}).proposal.proposal.getProposals();
};

UserWelcomeMainView.prototype.load = function(username) {
	var _this = this;
	this.username = username;
	
	/** Loading proposals depending on your role **/
	var credential = EXI.credentialManager.getCredentialByUserName(username);
	if (credential != null){
		if (credential.roles != null){
			if (credential.roles.length == 0){
				/** Assuming they are always users **/
				credential.roles.push(&quot;user&quot;);
			}
			if (credential.isManager()){
				alert(&quot;You are manager&quot;);
				return;
			}
			
			if (credential.isLocalContact()){
				alert(&quot;You are localContact&quot;);
				return;
			}
			this.loadUserView();
		}
	}
	
};

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
